# /.github/workflows/scaffold-evidence-from-runbooks.yml
name: Scaffold evidence folders from runbooks (path-based slugs)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scaffold:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create evidence scaffolds for all runbooks (unique by relative path)
        shell: bash
        run: |
          set -euo pipefail

          mapfile -t RUNBOOKS < <(find runbooks -type f -name "*.md" -not -path "*/.git/*" | sort)

          if [ "${#RUNBOOKS[@]}" -eq 0 ]; then
            echo "No runbooks found under /runbooks"
            exit 0
          fi

          for rb in "${RUNBOOKS[@]}"; do
            rb_no_ext="${rb%.md}"
            slug="$(echo "$rb_no_ext" | sed -E 's#^\.?/##; s#[/\\]+#-#g')"

            ev_dir="evidence/${slug}"

            mkdir -p "${ev_dir}/commands" "${ev_dir}/exports" "${ev_dir}/screenshots"

            touch "${ev_dir}/.gitkeep"
            touch "${ev_dir}/commands/.gitkeep"
            touch "${ev_dir}/exports/.gitkeep"
            touch "${ev_dir}/screenshots/.gitkeep"

            # IMPORTANT: grep returns exit code 1 when it finds nothing.
            # With -e and pipefail, that kills the whole job.
            # So make Tag parsing non-fatal and default to B.
            tag="$(
              (grep -E '^[[:space:]]*Tag:[[:space:]]*' "$rb" || true) \
              | head -n 1 \
              | sed -E 's/^[[:space:]]*Tag:[[:space:]]*//'
            )"
            if [ -z "${tag}" ]; then
              tag="B"
            fi

            if [ ! -f "${ev_dir}/notes.md" ]; then
              cat > "${ev_dir}/notes.md" <<EOF
          # Notes

          Tag: ${tag}
          Runbook: /${rb}

          - What happened:
          - Impact:
          - Root cause:
          - Fix:
          - Follow-ups:
          EOF
            fi

            if [ ! -f "${ev_dir}/timeline.md" ]; then
              cat > "${ev_dir}/timeline.md" <<EOF
          # Timeline

          Tag: ${tag}
          Runbook: /${rb}

          - T0:
          - T1:
          - T2:
          EOF
            fi

            if [ ! -f "${ev_dir}/README.md" ]; then
              cat > "${ev_dir}/README.md" <<EOF
          # Evidence: ${slug}

          Tag: ${tag}
          Canonical runbook: /${rb}

          Folder layout:
          - commands/      (CLI/PowerShell outputs, redacted)
          - exports/       (CSV/JSON exports, redacted)
          - screenshots/   (redacted images)
          - notes.md
          - timeline.md
          EOF
            fi
          done

       - name: Commit and push (rebase + retry)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add evidence/

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          # Sync with latest main so push can fast-forward
          git fetch origin main
          git pull --rebase origin main

          git commit -m "Scaffold evidence folders for runbooks (path-based slugs)"

          # Push, and if another run beat us, rebase and retry once
          if ! git push origin HEAD:main; then
            echo "Push failed (non-fast-forward). Rebasing and retrying once..."
            git fetch origin main
            git pull --rebase origin main
            git push origin HEAD:main
          fi

          git commit -m "Scaffold evidence folders for runbooks (path-based slugs)"
          git push
